---
title: "Homework 6"
author: "Eileen Shea"
date: "November 27, 2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

library(tidyverse)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

## Problem 1

First we need to read in the data.

```{r}
homicide_data = read_csv("./data/homicide-data.csv")
```

Next we will create a `city_state` variable and a binary variable indicating whether the homicide is solved. We will also omit the cities Dallas, TX; Phoenix, AZ; Kansas City, MO; and Tulsa, AL. Lastly, we will modify `victim_race` to have categories white and non-white, with white as the reference category, and change victim_age to a numeric variable.

```{r}
US_hom_data = homicide_data %>% 
  mutate(state = toupper(state), city_state = str_c(city, state, sep = ", "),
        resolved = ifelse(disposition == "Closed without arrest" | disposition == "Open/No arrest", FALSE, TRUE)) %>% 
  filter(city_state != "Dallas, TX", city_state != "Phoenix, AZ", city_state != "Kansas City, MO", city_state != "Tulsa, AL") %>% 
  mutate(victim_race = ifelse(victim_race == "White", "White", "Non-White"),
         victim_race = factor(victim_race, levels = c("White", "Non-White")),
         victim_age  = as.numeric(victim_age))
```

Now for the city of Baltimore, MD we will fit a logistic regression model with resolved vs unresolved as the outcome and victim age, sex, and race as predictors. 

```{r}
Baltimore_log_reg = 
  US_hom_data %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(resolved ~ victim_age + victim_sex + victim_race, 
    data = .,
    family = binomial())
```

Using the saved object of the `glm` output, we will tidy and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing non-white victims to white victims keeping all other variables fixed.

**OR and its Confidence Interval:**

```{r}
Baltimore_log_reg %>% 
  broom::tidy() %>% 
  filter(term == "victim_raceNon-White") %>% 
  mutate(est_OR = exp(estimate), 
        OR_CI_low = exp(estimate - 1.96*std.error),
        OR_CI_high = exp(estimate + 1.96*std.error)) %>% 
  select(est_OR, OR_CI_low, OR_CI_high) %>% 
  knitr::kable(digits = 3)
```

Now we will run the `glm` function and extract the adjusted odds ratio and confidence interval for each city.

```{r}
city_log_reg = 
  US_hom_data %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(resolved ~ victim_age + victim_sex + victim_race, data = .x, family = binomial())),
         models = map(models, broom::tidy)) %>% 
  select(-data) %>% 
  unnest()
```

```{r}
city_OR_df = city_log_reg %>% 
  filter(term == "victim_raceNon-White") %>% 
  mutate(est_OR = exp(estimate), 
        OR_CI_low = exp(estimate - 1.96*std.error),
        OR_CI_high = exp(estimate + 1.96*std.error)) %>% 
  select(city_state, est_OR, OR_CI_low, OR_CI_high)
```

With this dataframe containing ORs and confidence intervals for each city, we can make a plot.

```{r}
city_OR_df %>% 
  mutate(city_state = forcats::fct_reorder(city_state, est_OR)) %>% 
  ggplot(aes(x = city_state, y = est_OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = OR_CI_low, ymax = OR_CI_high)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 6)) +
  labs(
    title = "Odds ratio for resolved homicide case comparing non-white to white victims",
    x = "U.S. City",
    y = "Odds Ratio (w/ Confidence Interval)",
    caption = "Data from The Washington Post"
  ) 
```

From the plot we see that most of the odds ratio estimates are below 1; this means that the odds of having a resolved homicide case for a non-white victim are generally lower than the odds of having a resolved homicide case for a white victim. However, a number of confidence intervals cross 1, making the association between victim race and case resolution less clear in some cities. 

## Problem 2 



